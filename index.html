<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Prueba mapa Leaflet + Esri-Leaflet</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    html, body { height: 100%; margin: 0; }
    #map { width: 100%; height: 100vh; }

    .custom-control.leaflet-bar {
      background: white;
      box-shadow: 0 1px 5px rgba(0,0,0,0.4);
    }
    .custom-control.leaflet-bar a{
      display: block; 
      padding: 10px 12px; 
      line-height: 1.3; 
      text-align: center;
      text-decoration: none; 
      cursor: pointer;
      color: #333;
      font-size: 12px;
      min-width: 70px;
      white-space: nowrap;
    }
    .custom-control.leaflet-bar a:hover {
      background-color: #f4f4f4;
    }
    /* Controles arriba a la derecha: uno debajo del otro */
    .leaflet-top.leaflet-right {
      display: flex;
      flex-direction: column;
      gap: 10px;
      align-items: flex-end;
    }
    .leaflet-top.leaflet-right .custom-control{ 
      margin-top: 0; 
      margin-right: 10px;
    }

    /* Estilos para la leyenda */
    .legend-control {
      background: white;
      padding: 10px;
      box-shadow: 0 1px 5px rgba(0,0,0,0.4);
      border-radius: 5px;
      line-height: 1.5;
      font-size: 12px;
      max-width: 220px;
      margin-bottom: 10px;
    }
    .legend-control h4 {
      margin: 0 0 8px 0;
      font-size: 13px;
      font-weight: bold;
      border-bottom: 1px solid #ddd;
      padding-bottom: 5px;
    }
    .legend-item {
      margin: 5px 0;
      display: flex;
      align-items: center;
    }
    .legend-color {
      width: 20px;
      height: 15px;
      margin-right: 8px;
      border: 1px solid #999;
      flex-shrink: 0;
    }
    .legend-label {
      font-size: 11px;
      color: #333;
    }
    
    /* Abajo-izquierda: leyenda en columna */
    .leaflet-bottom.leaflet-left {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 10px;
    }
    .leaflet-control-scale {
      margin: 0 !important;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- Librer√≠as -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/esri-leaflet@3.0.12/dist/esri-leaflet.js"></script>
  <script src="https://unpkg.com/esri-leaflet-renderers@3.0.1/dist/esri-leaflet-renderers.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/wicket/1.3.6/wicket.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tokml/0.4.0/tokml.min.js"></script>

  <!-- Fallback si tokml CDN falla -->
  <script>
  if (typeof window.tokml !== "function") {
    console.warn("[tokml] CDN no disponible. Activando fallback b√°sico para Polygon/MultiPolygon.");
    function coordsToKmlRing(ring){
      if (ring.length){ const f=ring[0], l=ring[ring.length-1]; if (f[0]!==l[0]||f[1]!==l[1]) ring=ring.concat([f]); }
      return ring.map(([lon,lat])=>`${lon},${lat},0`).join(" ");
    }
    function polygonToKml(poly){
      const outer=poly[0]||[], holes=poly.slice(1)||[];
      let xml=`<Polygon>
<outerBoundaryIs><LinearRing><coordinates>${coordsToKmlRing(outer)}</coordinates></LinearRing></outerBoundaryIs>`;
      for (const h of holes){ xml+=`\n<innerBoundaryIs><LinearRing><coordinates>${coordsToKmlRing(h)}</coordinates></LinearRing></innerBoundaryIs>`; }
      xml+=`\n</Polygon>`;
      return xml;
    }
    function geometryToKml(geom){
      if (!geom||!geom.type) throw new Error("Geom inv√°lida");
      if (geom.type==="Polygon") return polygonToKml(geom.coordinates);
      if (geom.type==="MultiPolygon") return `<MultiGeometry>\n${geom.coordinates.map(p=>polygonToKml(p)).join("\n")}\n</MultiGeometry>`;
      throw new Error("Tipo no soportado: "+geom.type);
    }
    window.tokml=function(thing,opts={}){
      const feature=(thing&&thing.type==="Feature")?thing:{type:"Feature",geometry:thing,properties:{}};
      const name=(opts.name&&feature.properties&&feature.properties[opts.name])?String(feature.properties[opts.name])
                 :(feature.properties&&feature.properties.name)?String(feature.properties.name):"Feature";
      const kmlGeom=geometryToKml(feature.geometry);
      return `<?xml version="1.0" encoding="UTF-8"?>
<kml xmlns="http://www.opengis.net/kml/2.2"><Document>
<Placemark><name>${name}</name>${kmlGeom}</Placemark>
</Document></kml>`;
    };
  }
  </script>

  <script>
  window.addEventListener("DOMContentLoaded", () => {
    // =================== Datos est√°ticos para pruebas ===================
    const crcafe_point   = [9.933, -84.080];
    const idFinca        = "EJEMPLO_1";
    const crcafe_polygon = "POLYGON((-84.082 9.931, -84.078 9.931, -84.078 9.935, -84.082 9.935, -84.082 9.931))";

    // =================== Inicializar mapa ======================
    const map = L.map("map", { minZoom: 2, preferCanvas: true })
      .setView([9.7489, -83.7534], 8);

    L.tileLayer(
      "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
      { attribution: "Tiles ¬© Esri ‚Äî Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP",
        minZoom: 2, maxZoom: 22, maxNativeZoom: 13 }
    ).addTo(map);

    // Panes
    map.createPane("pane-low");   map.getPane("pane-low").style.zIndex  = 401;
    map.createPane("pane-mid");   map.getPane("pane-mid").style.zIndex  = 402;
    map.createPane("pane-high");  map.getPane("pane-high").style.zIndex = 403;

    // =================== Capas Esri Leaflet =====================
    const buffer60m = L.esri.featureLayer({
      url: "https://services5.arcgis.com/LF48CxpifRE4aglv/arcgis/rest/services/Buffer_60m/FeatureServer/0",
      pane: "pane-mid",
      style: () => ({ color: "#00C5FF", weight: 1.5, fillColor: "#98D27D", fillOpacity: 0.49 })
    });

    const territoriosIndigenas = L.esri.featureLayer({
      url: "https://services5.arcgis.com/LF48CxpifRE4aglv/arcgis/rest/services/Terrirtorios_Indigenas_CR_2022_PV/FeatureServer/0",
      pane: "pane-low",
      style: () => ({ color: "#267300", weight: 1.5, fillColor: "#98D27D", fillOpacity: 0.49 })
    });

    const areasProtegidas = L.esri.featureLayer({
      url: "https://services5.arcgis.com/LF48CxpifRE4aglv/arcgis/rest/services/ASP_No_Cultivo/FeatureServer/0",
      pane: "pane-low",
      style: () => ({ color: "#F57A7A", weight: 1.5, fillColor: "#F0DFD8", fillOpacity: 0.49 })
    });

    const coberturaForestal = L.esri.featureLayer({
      url: "https://services5.arcgis.com/LF48CxpifRE4aglv/arcgis/rest/services/Cobertura_Forestal_2023/FeatureServer/0",
      pane: "pane-low",
      style: () => ({ color: "#38A800", weight: 0.7, fillColor: "#C6E2B2", fillOpacity: 0.5 })
    });

    const tmf2024 = L.esri.featureLayer({
      url: "https://services5.arcgis.com/LF48CxpifRE4aglv/arcgis/rest/services/TMF_2024/FeatureServer/0",
      pane: "pane-high"
    });

    const gfwCR = L.esri.featureLayer({
      url: "https://services5.arcgis.com/LF48CxpifRE4aglv/arcgis/rest/services/GFW_CR/FeatureServer/0",
      pane: "pane-high"
    });

    // Popups
    buffer60m.bindPopup(l => `<b>Buffer 60 m</b><br>ID_Finca: ${l.feature?.properties?.ID ?? "‚Äî"}`);
    territoriosIndigenas.bindPopup(l => `<b>Territorio Ind√≠gena</b><br>${l.feature?.properties?.TERRITORIO ?? "‚Äî"}`);
    areasProtegidas.bindPopup(l => `<b>√Årea Protegida</b><br>${l.feature?.properties?.cat_manejo ?? "‚Äî"}<br>${l.feature?.properties?.nombre_asp ?? "‚Äî"}`);
    coberturaForestal.bindPopup(l => `<b>Cobertura Forestal</b><br>${l.feature?.properties?.Clase ?? "‚Äî"}`);
    tmf2024.bindPopup(l => `<b>TMF</b><br>${l.feature?.properties?.Alerta ?? l.feature?.properties?.ALERTA ?? "‚Äî"}`);
    gfwCR.bindPopup(l => `<b>Global Forest Watch</b><br><b>A√±o:</b> ${l.feature?.properties?.Ano ?? l.feature?.properties?.ANO ?? "‚Äî"}<br><b>Confianza:</b> ${l.feature?.properties?.Confianza ?? l.feature?.properties?.CONFIANZA ?? "‚Äî"}`);

    // =============== Control "Exportar pol√≠gono" ===============
    const ExportControl = L.Control.extend({
      options: { position: "topright" },
      onAdd: function () {
        const div = L.DomUtil.create("div", "leaflet-control custom-control leaflet-bar");
        const a = L.DomUtil.create("a", "", div);
        a.id = "exportControlLink";
        a.href = "#";
        a.title = "Exportar pol√≠gono de la finca";
        a.innerHTML = "<b>üì§ Exportar<br>Pol√≠gono</b>";
        L.DomEvent.disableClickPropagation(div);
        a.addEventListener("click", (e) => {
          e.preventDefault();
          if (window._kmlString && typeof window._kmlString === "string") {
            exportKML(window._kmlString, "finca_" + idFinca + ".kml");
          } else {
            alert("No hay KML para exportar.");
          }
        });
        return div;
      }
    });
    map.addControl(new ExportControl());

    // Control de capas (AHORA TAMBI√âN ARRIBA-DERECHA, debajo del exportar)
    const layersControl = L.control.layers(null, {
      "Buffer 60 m": buffer60m,
      "TMF 2024": tmf2024,
      "Global Forest Watch": gfwCR,
      "Territorios Ind√≠genas": territoriosIndigenas,
      "√Åreas Protegidas": areasProtegidas,
      "Cobertura Forestal": coberturaForestal
    }, { collapsed: false, position: "topright" }).addTo(map);

    // =============== Control "Leyenda" ===============
    const LegendControl = L.Control.extend({
      options: { position: "bottomleft" },
      onAdd: function () {
        const div = L.DomUtil.create("div", "leaflet-control legend-control");
        div.innerHTML = `
          <h4>SIMBOLOGIA</h4>
          <div class="legend-item">
            <div class="legend-color" style="background-color: rgba(55, 168, 74, 0.2); border-color: #ffffff;"></div>
            <span class="legend-label">Finca Seleccionada</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background-color: rgba(152, 210, 125, 0.49); border-color: #00C5FF;"></div>
            <span class="legend-label">Buffer 60 m</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background-color: rgba(152, 210, 125, 0.49); border-color: #267300;"></div>
            <span class="legend-label">Territorios Ind√≠genas</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background-color: rgba(240, 223, 216, 0.49); border-color: #F57A7A;"></div>
            <span class="legend-label">√Åreas Protegidas</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background-color: rgba(198, 226, 178, 0.5); border-color: #38A800;"></div>
            <span class="legend-label">Cobertura Forestal</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background: linear-gradient(135deg, #ff6b6b 0%, #ffd93d 50%, #6bcf7f 100%); border-color: #333;"></div>
            <span class="legend-label">TMF 2024</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background: linear-gradient(135deg, #e74c3c 0%, #f39c12 50%, #27ae60 100%); border-color: #333;"></div>
            <span class="legend-label">Global Forest Watch</span>
          </div>
        `;
        L.DomEvent.disableClickPropagation(div);
        return div;
      }
    });
    map.addControl(new LegendControl());

    // =================== Escala =====================
    L.control.scale({ 
      imperial: false, 
      position: 'bottomright',
      maxWidth: 150
    }).addTo(map);

    // =================== WKT ‚Üí GeoJSON ‚Üí pol√≠gono + KML =====================
    window._lastWkt = (crcafe_polygon || "").trim();

    function sanitizeWKT(wkt) {
      let s = (wkt || "").trim();
      s = s.replace(/^SRID=\d+;\s*/i, "");
      s = s.replace(/\b(POINT|MULTIPOINT|LINESTRING|MULTILINESTRING|POLYGON|MULTIPOLYGON)\s+Z?M?\s*\(/ig, (m,g)=>g.toUpperCase()+"(");
      s = s.replace(/(\d),(\d)/g, "$1.$2");
      s = s.replace(/\s+/g, " ");
      return s;
    }
    
    function wktToGeoJSONGeometryOrThrow(wkt) {
      const w = new Wkt.Wkt();
      w.read(wkt);
      const geom = w.toJson();
      if (!geom || !geom.type || !geom.coordinates) throw new Error("GeoJSON geometry inv√°lida");
      return geom;
    }
    
    function tryClosePolygonRings(wkt) {
      const polyRe = /^POLYGON\s*\(\((.+)\)\)\s*$/i;
      const m = wkt.match(polyRe);
      if (!m) return wkt;
      const inner = m[1];
      const rings = inner.split(/\)\s*,\s*\(/);
      const fixed = rings.map(ring => {
        const coords = ring.split(/\s*,\s*/);
        if (coords.length < 3) return ring;
        const first = coords[0].trim();
        const last  = coords[coords.length - 1].trim();
        if (first !== last) coords.push(first);
        return coords.join(", ");
      });
      return "POLYGON((" + fixed.join("),(") + "))";
    }
    
    function buildKMLFromGeometry(geom, name="finca") {
      const feature = { type: "Feature", geometry: geom, properties: { name } };
      const kml = tokml(feature, { name: "name" });
      if (!kml || kml.length < 10) throw new Error("tokml vac√≠o");
      return kml;
    }

    // =================== DIBUJAR FINCA Y HACER ZOOM ===================
    (function drawFarmFromWKT(){
      if (!window._lastWkt) { 
        map.setView(crcafe_point, 18);
        L.marker(crcafe_point).addTo(map).bindPopup("ID Finca = " + idFinca);
        return; 
      }
      
      try {
        const cleaned = sanitizeWKT(window._lastWkt);
        let geom;
        try {
          geom = wktToGeoJSONGeometryOrThrow(cleaned);
        } catch (e1) {
          const closed = tryClosePolygonRings(cleaned);
          geom = wktToGeoJSONGeometryOrThrow(closed);
        }

        const polyLayer = L.geoJSON(geom, {
          pane: "pane-high",
          style: { fillColor: "#37a84a", fillOpacity: 0.2, color: "#ffffff", weight: 2 }
        }).addTo(map).bindPopup("<b>Finca:</b> " + idFinca);

        L.marker(crcafe_point).addTo(map)
          .bindPopup("<b>ID Finca:</b> " + idFinca);

        window._kmlString = buildKMLFromGeometry(geom, "finca " + idFinca);
        
        const bounds = polyLayer.getBounds();
        window._fincaBounds = bounds;
        map.fitBounds(bounds, { padding: [50, 50], maxZoom: 16 });
        
      } catch (err) {
        console.error("Error procesando WKT:", err, "\nWKT original:", window._lastWkt);
        alert("El WKT no es v√°lido o no pudo procesarse. Revisa la consola (F12).");
        map.setView(crcafe_point, 18);
        L.marker(crcafe_point).addTo(map).bindPopup("ID Finca = " + idFinca);
      }
    })();

    // ===== Exportaci√≥n por Blob =====
    function exportKML(kmlText, filename) {
      try {
        const blob = new Blob([kmlText], { type: "application/vnd.google-earth.kml+xml;charset=utf-8" });
        const url  = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.style.display = "none";
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        setTimeout(() => URL.revokeObjectURL(url), 1500);
      } catch (err) {
        console.error("Error al exportar KML:", err);
        alert("No se pudo exportar el KML. Revisa la consola (F12) para m√°s detalles.");
      }
    }
  });
  </script>
</body>
</html>
